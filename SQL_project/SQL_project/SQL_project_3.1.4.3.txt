DELIMITER $$

CREATE TRIGGER check_application_status_update
BEFORE UPDATE ON applies
FOR EACH ROW
BEGIN
    DECLARE job_start DATE;
    DECLARE active_applications INT;

    SELECT start_date INTO job_start FROM job WHERE id = NEW.job_id;

    IF NEW.status = 'cancelled' AND CURRENT_DATE > (job_start - INTERVAL 10 DAY) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Applications cannot be cancelled less than 10 days before the job start date.';
    END IF;

    SELECT COUNT(*) INTO active_applications FROM applies 
    WHERE cand_username = NEW.cand_username AND status = 'active';

    IF NEW.status = 'active' AND OLD.status = 'cancelled' AND active_applications >= 3 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cannot reactivate a cancelled application if the employee already has three active applications.';
    END IF;
END$$

DELIMITER ;






--TEST

INSERT INTO job (title, start_date, salary, position, edra, evaluator, announce_date, submission_date)
VALUES ('Example Job', '2024-01-30', 50000, 'Example Position', 'Example Location', 'user3', '2024-01-20', '2024-01-29');

-- Replace 1 with the actual job_id from the job you just created
INSERT INTO applies (cand_username, job_id, status, application_date)
VALUES ('user3', 1, 'active', '2024-01-20');

-- Replace 11 with the actual job_id
UPDATE applies
SET status = 'cancelled'
WHERE cand_username = 'user1' AND job_id = 1;

UPDATE applies
SET status = 'cancelled'
WHERE cand_username = 'user12' AND job_id = 17;

-- Replace 1 with an actual job_id where 'user12' can apply
INSERT INTO applies (cand_username, job_id, status, application_date)
VALUES ('user12', 1, 'active', '2024-01-01');

UPDATE applies
SET status = 'active'
WHERE cand_username = 'user12' AND job_id = 1;
